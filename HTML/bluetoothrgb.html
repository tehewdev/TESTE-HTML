<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlador RGB Universal (Scan Total)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-color: #0f172a; 
            --card-bg: #1e293b; 
            --accent: #8b5cf6; 
            --text-main: #f1f5f9; 
            --text-muted: #94a3b8; 
            --success: #10b981; 
            --error: #ef4444; 
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-main); display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; }
        .container { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 20px; }
        
        h1 { text-align: center; font-size: 1.4rem; font-weight: 600; }
        .subtitle { text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-top: -15px; margin-bottom: 10px;}

        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; gap: 15px;}
        
        /* Bot√£o Principal */
        .btn-action { width: 100%; background: var(--accent); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-action:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-action:active { transform: translateY(0); }

        /* Controles */
        .control-panel { opacity: 0.4; pointer-events: none; transition: 0.3s; display: flex; flex-direction: column; gap: 15px; }
        .control-panel.active { opacity: 1; pointer-events: auto; }

        .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-power { padding: 15px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; color: white; font-size: 0.9rem; }
        .btn-on { background: var(--success); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .btn-off { background: var(--error); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }

        /* Color Picker Customizado */
        .color-wrapper { width: 100%; height: 70px; position: relative; overflow: hidden; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1); background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); }
        input[type="color"] { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; cursor: pointer; border: none; opacity: 0; }
        .color-label { position: absolute; pointer-events: none; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); font-weight: 600; text-shadow: 0 1px 3px black; backdrop-filter: blur(2px); }

        /* Terminal */
        .terminal-window { background: #0b101e; border-radius: 12px; height: 200px; overflow: hidden; border: 1px solid #333; display: flex; flex-direction: column; }
        .terminal-header { background: #1e293b; padding: 5px 15px; font-size: 0.75rem; color: #64748b; border-bottom: 1px solid #333; }
        .terminal-content { padding: 15px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: #10b981; overflow-y: auto; flex-grow: 1; line-height: 1.5; }
        .log-time { color: #475569; margin-right: 8px; } 
        .log-tx { color: #3b82f6; } 
        .log-err { color: #ef4444; }
        .log-warn { color: #fbbf24; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Scanner RGB Universal</h1>
        <div class="subtitle">Bluetooth Web API ‚Ä¢ FFF0 Protocol</div>

        <div class="card">
            <div id="connStatus" style="text-align:center; color:var(--text-muted); font-weight: 600;">Desconectado</div>
            <button id="btnConnect" class="btn-action">üîç Buscar Dispositivos</button>
        </div>

        <!-- Painel de Controle -->
        <div class="card control-panel" id="controlPanel">
            <div class="control-grid">
                <button class="btn-power btn-on" onclick="sendPower(true)">LIGAR</button>
                <button class="btn-power btn-off" onclick="sendPower(false)">DESLIGAR</button>
            </div>
            
            <div class="color-wrapper">
                <div class="color-label">Toque para mudar a Cor</div>
                <input type="color" id="colorPicker" value="#ff0000">
            </div>
        </div>

        <div class="terminal-window">
            <div class="terminal-header">LOG DO SISTEMA</div>
            <div class="terminal-content" id="console">
                <div><span class="log-time">--:--</span> Sistema pronto. Clique em Buscar.</div>
                <div style="color: #64748b; margin-top:5px;">Dica: Certifique-se que o Bluetooth do celular est√° DESLIGADO se estiver usando PC.</div>
            </div>
        </div>
    </div>

    <script>
        // Elementos da Interface
        const btnConnect = document.getElementById('btnConnect');
        const controlPanel = document.getElementById('controlPanel');
        const colorPicker = document.getElementById('colorPicker');
        const consoleDiv = document.getElementById('console');
        const uiStatus = document.getElementById('connStatus');

        // Vari√°veis Bluetooth
        let device, server, characteristic;

        // UUIDs Padr√£o (Chips Jieli/Triones/ELK)
        const SERVICE_UUID = '0000fff0-0000-1000-8000-00805f9b34fb';
        const CHAR_UUID    = '0000fff3-0000-1000-8000-00805f9b34fb';

        // Fun√ß√£o de Log Visual
        function log(msg, type = 'info') {
            const line = document.createElement('div');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            let colorClass = '';
            if(type === 'tx') colorClass = 'log-tx';
            if(type === 'error') colorClass = 'log-err';
            if(type === 'warn') colorClass = 'log-warn';
            
            line.innerHTML = `<span class="log-time">${time}</span> <span class="${colorClass}">${msg}</span>`;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        // 1. CONEX√ÉO
        async function connect() {
            try {
                if (device && device.gatt.connected) {
                    await device.gatt.disconnect();
                    return;
                }

                // Limpa logs antigos
                consoleDiv.innerHTML = '<div><span class="log-time">--:--</span> Iniciando busca...</div>';
                
                log("Abrindo seletor Bluetooth...", 'warn');

                // --- AQUI EST√Å A MUDAN√áA CR√çTICA ---
                device = await navigator.bluetooth.requestDevice({
                    // Isso for√ßa o navegador a mostrar TUDO, sem filtrar nome
                    acceptAllDevices: true,
                    // Precisamos avisar que vamos querer usar este servi√ßo depois
                    optionalServices: [SERVICE_UUID]
                });

                log(`Selecionado: ${device.name || 'Dispositivo sem nome'}`);
                
                device.addEventListener('gattserverdisconnected', onDisconnect);

                log("Conectando ao Servidor GATT...");
                server = await device.gatt.connect();
                
                log("Buscando Servi√ßo de Controle (FFF0)...");
                // Se a l√¢mpada n√£o tiver esse servi√ßo, vai dar erro aqui e pular pro catch
                const service = await server.getPrimaryService(SERVICE_UUID);
                
                log("Buscando Caracter√≠stica de Escrita (FFF3)...");
                characteristic = await service.getCharacteristic(CHAR_UUID);

                onConnect(); // Sucesso!

            } catch (err) {
                log("FALHA: " + err.message, 'error');
                
                // Ajuda o usu√°rio a entender o erro
                if(err.message.includes("No Services matching")) {
                    log("‚ö†Ô∏è Esta l√¢mpada conectou, mas n√£o usa o protocolo FFF0 padr√£o.", 'warn');
                    log("Tente usar o App nRF Connect para descobrir o UUID dela.", 'warn');
                }
                else if(err.message.includes("User cancelled")) {
                    log("Sele√ß√£o cancelada pelo usu√°rio.");
                }
                else if(err.message.includes("GATT Server is disconnected")) {
                    log("A l√¢mpada desconectou imediatamente. Ela pode estar pareada com o celular.", 'warn');
                }
            }
        }

        function onConnect() {
            uiStatus.textContent = "CONECTADO: " + (device.name || "Dispositivo");
            uiStatus.style.color = "#10b981"; // Verde
            btnConnect.textContent = "Desconectar";
            btnConnect.style.background = "#ef4444"; // Vermelho
            
            controlPanel.classList.add('active');
            log("Pronto! Tente mudar a cor.");
        }

        function onDisconnect() {
            uiStatus.textContent = "Desconectado";
            uiStatus.style.color = "#94a3b8";
            btnConnect.textContent = "üîç Buscar Dispositivos";
            btnConnect.style.background = ""; 
            
            controlPanel.classList.remove('active');
            log("Dispositivo desconectado.", 'warn');
        }

        // 2. ENVIO DE DADOS (Hexadecimal)
        async function sendCommand(dataArray) {
            if (!characteristic) {
                log("Erro: N√£o conectado.", 'error');
                return;
            }
            try {
                const buffer = new Uint8Array(dataArray);
                await characteristic.writeValue(buffer);
                
                // Formata para exibir bonito no log
                const hexStr = [...buffer].map(b => b.toString(16).padStart(2,'0').toUpperCase()).join(' ');
                log(`Enviado: ${hexStr}`, 'tx');
            } catch (e) {
                log("Erro ao enviar: " + e.message, 'error');
            }
        }

        // Protocolo Gen√©rico (ELK-BLEDOM / Triones)
        // Estrutura: 7E 00 05 03 R G B 00 EF
        async function sendColor(hex) {
            const r = parseInt(hex.substring(1, 3), 16);
            const g = parseInt(hex.substring(3, 5), 16);
            const b = parseInt(hex.substring(5, 7), 16);

            await sendCommand([0x7E, 0x00, 0x05, 0x03, r, g, b, 0x00, 0xEF]);
        }

        async function sendPower(isOn) {
            // Liga: 7E 00 04 01 ... | Desliga: 7E 00 04 00 ...
            const state = isOn ? 0x01 : 0x00;
            await sendCommand([0x7E, 0x00, 0x04, state, 0x00, 0x00, 0x00, 0x00, 0xEF]);
        }

        // 3. EVENTOS
        btnConnect.addEventListener('click', connect);

        // Throttle para n√£o travar a l√¢mpada (envia no m√°ximo 1 comando a cada 100ms)
        let isBusy = false;
        colorPicker.addEventListener('input', (e) => {
            if(isBusy) return;
            isBusy = true;
            
            sendColor(e.target.value).finally(() => {
                setTimeout(() => { isBusy = false; }, 100); 
            });
        });

    </script>
</body>
</html>