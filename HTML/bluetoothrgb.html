<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlador RGB Multi-Protocolo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #f1f5f9; font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 15px; }
        h2 { text-align: center; color: #38bdf8; }
        
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; font-size: 1rem; }
        .btn-scan { background: #3b82f6; }
        .btn-on { background: #10b981; }
        .btn-off { background: #ef4444; }
        
        .controls { opacity: 0.4; pointer-events: none; display: flex; flex-direction: column; gap: 10px; transition: 0.3s; }
        .controls.active { opacity: 1; pointer-events: auto; }
        
        .color-box { height: 80px; border-radius: 10px; border: 2px solid #333; overflow: hidden; position: relative; }
        input[type="color"] { position: absolute; width: 150%; height: 150%; top: -25%; left: -25%; cursor: pointer; border: none; }
        
        .log-box { background: #000; color: #0f0; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; padding: 10px; height: 150px; overflow-y: auto; border-radius: 8px; border: 1px solid #333; }
        .log-err { color: #ef4444; } .log-warn { color: #fbbf24; } .log-succ { color: #38bdf8; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Chave Mestra RGB üóùÔ∏è</h2>
        
        <button id="btnScan" class="btn btn-scan">üîç Procurar e Testar Portas</button>
        <div id="status" style="text-align:center; color:#94a3b8; font-size:0.9rem;">Desconectado</div>

        <div class="controls" id="controls">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-on" onclick="setPower(true)">LIGAR</button>
                <button class="btn btn-off" onclick="setPower(false)">DESLIGAR</button>
            </div>
            <div class="color-box">
                <input type="color" id="colorPicker" value="#ff0000">
            </div>
            <div style="text-align:center; font-size:0.8rem; color:#ccc;">Toque na cor para mudar</div>
        </div>

        <div class="log-box" id="log"></div>
    </div>

    <script>
        const ui = {
            status: document.getElementById('status'),
            controls: document.getElementById('controls'),
            scanBtn: document.getElementById('btnScan')
        };
        
        let device, charWriter;
        
        // LISTA DE UUIDS POSS√çVEIS (As "Portas" que vamos testar)
        const PROTOCOLS = [
            { name: "Padr√£o Triones (FFF0)", svc: '0000fff0-0000-1000-8000-00805f9b34fb', char: '0000fff3-0000-1000-8000-00805f9b34fb' },
            { name: "Serial HM-10 (FFE0)",   svc: '0000ffe0-0000-1000-8000-00805f9b34fb', char: '0000ffe1-0000-1000-8000-00805f9b34fb' },
            { name: "Serial Alt (FFE5)",     svc: '0000ffe5-0000-1000-8000-00805f9b34fb', char: '0000ffe9-0000-1000-8000-00805f9b34fb' },
            { name: "LEDnet / Magic (AAA0)", svc: '0000aaa0-0000-1000-8000-00805f9b34fb', char: '0000aaa1-0000-1000-8000-00805f9b34fb' },
            { name: "JCY / Varia√ß√£o (FFD5)", svc: '0000ffd5-0000-1000-8000-00805f9b34fb', char: '0000ffd9-0000-1000-8000-00805f9b34fb' }
        ];

        function log(msg, type = '') {
            const div = document.createElement('div');
            div.innerText = `> ${msg}`;
            if(type) div.className = `log-${type}`;
            document.getElementById('log').appendChild(div);
            document.getElementById('log').scrollTop = 9999;
        }

        async function connect() {
            try {
                ui.scanBtn.disabled = true;
                log("Iniciando scan multi-protocolo...");

                // 1. Pede permiss√£o para TUDO da nossa lista
                const allServices = PROTOCOLS.map(p => p.svc);
                
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [...allServices] // Importante: Pedir permiss√£o para todos
                });

                device.addEventListener('gattserverdisconnected', () => {
                    ui.status.innerText = "Desconectado";
                    ui.controls.classList.remove('active');
                    ui.scanBtn.disabled = false;
                    ui.scanBtn.innerText = "üîç Reconectar";
                    log("Dispositivo desconectado.", 'warn');
                });

                log(`Conectando a: ${device.name}...`);
                const server = await device.gatt.connect();
                log("Conectado! Procurando servi√ßo compat√≠vel...", 'succ');

                // 2. Testa qual UUID existe na l√¢mpada
                let foundProtocol = null;
                
                for (const proto of PROTOCOLS) {
                    try {
                        const service = await server.getPrimaryService(proto.svc);
                        log(`‚úÖ Encontrado: ${proto.name}`, 'succ');
                        
                        charWriter = await service.getCharacteristic(proto.char);
                        foundProtocol = proto;
                        break; // Achamos! Para de procurar.
                    } catch (e) {
                        // Falhou nesse protocolo, tenta o pr√≥ximo
                        log(`‚ùå N√£o √©: ${proto.name}`);
                    }
                }

                if (!foundProtocol) {
                    throw new Error("Nenhum protocolo conhecido encontrado nesta l√¢mpada.");
                }

                // Sucesso
                log(`Conectado usando protocolo: ${foundProtocol.name}`, 'succ');
                ui.status.innerText = `Conectado (${foundProtocol.name})`;
                ui.status.style.color = "#38bdf8";
                ui.controls.classList.add('active');
                ui.scanBtn.innerText = "Desconectar";
                ui.scanBtn.onclick = () => device.gatt.disconnect();

            } catch (err) {
                log(err.message, 'err');
                ui.scanBtn.disabled = false;
            }
        }

        // COMANDOS
        async function sendHex(hexArray) {
            if(!charWriter) return;
            try {
                await charWriter.writeValue(new Uint8Array(hexArray));
                log(`TX: ${hexArray.map(b=>b.toString(16).padStart(2,'0')).join(' ')}`);
            } catch(e) { log("Erro envio: " + e.message, 'err'); }
        }

        // Tenta usar o formato mais gen√©rico poss√≠vel (Magic Home / Triones misto)
        // Se a l√¢mpada ligar mas a cor n√£o bater, o formato do HEX precisa mudar.
        async function setColor(hex) {
            const r = parseInt(hex.substring(1,3), 16);
            const g = parseInt(hex.substring(3,5), 16);
            const b = parseInt(hex.substring(5,7), 16);
            
            // Padr√£o Triones (O mais comum)
            await sendHex([0x7E, 0x00, 0x05, 0x03, r, g, b, 0x00, 0xEF]);
        }

        async function setPower(isOn) {
            // Tenta comando Triones
            await sendHex([0x7E, 0x00, 0x04, isOn?1:0, 0x00, 0x00, 0x00, 0x00, 0xEF]);
            
            // Se n√£o funcionar, tenta comando simples (algumas fitas usam apenas 'CC 23 33')
            // Mas vamos focar no Triones primeiro.
        }

        document.getElementById('colorPicker').addEventListener('input', (e) => {
             setColor(e.target.value);
        });
        
        ui.scanBtn.addEventListener('click', connect);

    </script>
</body>
</html>