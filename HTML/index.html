<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TesteHTML Publisher</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImEiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjNjY3ZWVhIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM3NjRiYTIiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHJ4PSIxNCIgZmlsbD0idXJsKCNhKSIgLz4KICA8cGF0aCBmaWxsPSIjZmZmZmZmIiBkPSJNMjEgMThoOGw1IDkgNS05aDhsLTkgMTZ2MTJoLThWMzR6IiAvPgo8L3N2Zz4=">
    <style>
/* (O CSS aqui √© igual ao do seu exemplo: pode manter, editar, ou otimizar) */
body { font-family: sans-serif; background: #18181b; color: #f8f8f2; padding: 2rem;}
.container { background: #222127; border-radius: 18px; box-shadow: 0 20px 40px rgba(15,23,42,0.23); width: 100%; max-width: 820px; margin: auto; padding: 2.2rem 1.6rem;}
h1 { margin-bottom: 1rem; }
.hero { text-align: center; margin-bottom: 32px; }
input, textarea { background: #27272a; color: #f8f8f2; border: 1.5px solid #2e2e37; border-radius: 10px; padding: 12px; width: 100%; font-size: 16px;}
input:focus, textarea:focus { border-color: #6366f1; outline: none;}
label { font-weight: bold;}
.btn { padding: 12px 24px; margin-top: 10px; border-radius: 8px; cursor: pointer; font-size: 16px;}
.btn-primary { background: linear-gradient(135deg,#6366f1,#764ba2); border: none; color: #fff;}
.btn-secondary { background: #232134; color: #6366f1; border: 1.5px solid #2e2e37;}
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed;}
.file-list { margin-top: 34px; background: #27272a; border-radius: 14px; padding: 20px 22px; border: 1px solid #2e2e37;}
.file-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px;}
.file-list-content { display: flex; flex-direction: column; gap: 10px;}
.file-item { display: flex; justify-content: space-between; align-items: center; background: #18181b; border-radius: 10px; padding: 12px 14px; border: 1px solid #2e2e37; gap: 12px;}
.file-actions { display: flex; gap: 8px;}
.status { border-radius: 12px; padding: 16px 18px; margin-top: -6px; font-size: 14px; display: none;}
.status-info { display: block; background: #222152; color: #6366f1; border: 1px solid #6366f1;}
.status-success { display: block; background: #212f2e; color: #2dff71; border: 1px solid #2dff71;}
.status-error { display: block; background: #21181e; color: #f45a7e; border: 1px solid #f45a7e;}
.small {font-size: 13px; color: #a1a1aa;}
.btn-ghost, .btn-del { border-radius: 7px; font-size: 14px; cursor: pointer; border: none; padding: 9px 16px;}
.btn-ghost { background: #27272a; color: #6366f1;}
.btn-del { background: #201225; color: #f45a7e;}
.btn-del:hover { background: #3f1828;}
    </style>
</head>
<body>
<div class="container">
    <header class="hero">
        <h1>üöÄ TesteHTML Publisher</h1>
        <p class="intro">Publique rapidamente p√°ginas HTML diretamente no reposit√≥rio GitHub.</p>
    </header>
    <form id="publishForm" novalidate>
        <div class="field-group">
            <label for="filename">
                <span>Nome do arquivo (.html)</span>
                <span id="sanitizedPreview" class="hint">Nome resultante: minha-pagina.html</span>
            </label>
            <input type="text" id="filename" name="filename" value="minha-pagina.html" autocomplete="off" required
                aria-describedby="sanitizedPreview">
        </div>
        <div class="field-group">
            <label for="htmlContent">C√≥digo HTML</label>
            <textarea id="htmlContent" name="htmlContent" required rows="10"
                aria-label="Campo de c√≥digo HTML"><!DOCTYPE html>
<html lang="pt-BR">
<head><meta charset="UTF-8"><title>P√°gina Exemplo</title></head>
<body><h1>Publica√ß√£o din√¢mica via jsonbin.</h1></body>
</html></textarea>
        </div>
        <div class="button-row">
            <button type="button" class="btn btn-secondary" id="loadExampleBtn"
                aria-label="Carregar exemplo">üìã Carregar Exemplo</button>
            <button type="submit" class="btn btn-primary" id="publishBtn" disabled
                aria-label="Publicar no GitHub">üöÄ Publicar no GitHub</button>
        </div>
    </form>
    <div id="status" class="status" role="alert" aria-live="polite"></div>
    <section class="file-list" aria-label="Lista de arquivos existentes">
        <div class="file-list-header">
            <h2>Arquivos existentes</h2>
            <button type="button" class="btn-ghost" id="refreshBtn"
                aria-label="Atualizar lista de arquivos">Atualizar lista</button>
        </div>
        <div id="fileList" class="file-list-content">
            <span class="small">Carregando arquivos...</span>
        </div>
        <p class="small">Tempo de deploy: ~30s ap√≥s salvar, criar ou remover arquivos.</p>
    </section>
</div>
<script>
'use strict';
const CONFIG = {
  repo: { owner: 'tehewdev', name: 'teste-html', folder: 'HTML', branch: 'main' },
  preview: { baseUrl: 'papapapapapapa.onrender.com' },
  jsonbin: { binId: '690bda10ae596e708f473581', accessKey: '$2a$10$f9KK7vSowGnJI5elo/dAPurqjZAJ3bJaWnsinl/caDfgIcNt28kNi' },
  cache: { tokenKey: 'gh_token_cache', filesKey: 'gh_files_cache', duration: 1000 * 60 * 15 }
};
const DEFAULT_EXAMPLE = `<!DOCTYPE html>
<html lang="pt-BR">
<head><meta charset="UTF-8"><title>P√°gina Exemplo</title></head>
<body>
  <h1>Exemplo carregado do bot√£o!</h1>
  <p>O token √© carregado da bin privada.</p>
</body>
</html>`;
class GitHubTokenManager {
    constructor(config) { this.config = config; this.token = null;}
    async load() {
        const cached = this.getCache();
        if (cached) { this.token = cached; return cached;}
        try {
            const url = `https://api.jsonbin.io/v3/b/${this.config.jsonbin.binId}/latest`;
            const response = await fetch(url, {
                headers: { 'X-Access-Key': this.config.jsonbin.accessKey, 'X-Bin-Meta': 'false' }
            });
            if (!response.ok) throw new Error(`Erro ${response.status}: ${response.statusText}`);
            const data = await response.json();
            const token = data?.github_token;
            if (!token) throw new Error('Token n√£o encontrado na bin (campo "github_token")');
            this.token = token; this.setCache(token); return token;
        } catch (error) { console.error('Erro ao carregar token:', error); throw error;}
    }
    getCache() {
        try {
            const cached = localStorage.getItem(this.config.cache.tokenKey);
            if (!cached) return null;
            const { token, timestamp } = JSON.parse(cached);
            if (Date.now() - timestamp > this.config.cache.duration) { localStorage.removeItem(this.config.cache.tokenKey); return null;}
            return token;
        } catch { return null;}
    }
    setCache(token) {
        try { localStorage.setItem(this.config.cache.tokenKey, JSON.stringify({token, timestamp: Date.now()})); }
        catch (error) { console.warn('N√£o foi poss√≠vel salvar token no cache:', error);}
    }
    getAuthHeaders() {
        if (!this.token) throw new Error('Token n√£o carregado');
        return { 'Authorization': `Bearer ${this.token}`, 'Accept': 'application/vnd.github+json', 'X-GitHub-Api-Version': '2022-11-28' };
    }
    isLoaded() { return Boolean(this.token);}
}
class GitHubFileManager {
    constructor(config, tokenManager) { this.config = config; this.tokenManager = tokenManager; }
    async list() {
        if (!this.tokenManager.isLoaded()) throw new Error('Token n√£o carregado');
        const cached = this.getCache(); if (cached) return cached;
        try {
            const url = `https://api.github.com/repos/${this.config.repo.owner}/${this.config.repo.name}/contents/${this.config.repo.folder}?ref=${this.config.repo.branch}`;
            const response = await fetch(url, { headers: this.tokenManager.getAuthHeaders() });
            if (response.status === 404) return [];
            if (!response.ok) throw new Error(`${response.status}: ${response.statusText}`);
            const files = await response.json();
            if (!Array.isArray(files)) throw new Error('Resposta inesperada da API');
            const htmlFiles = files.filter(f => f.name?.endsWith('.html') && f.name !== 'index.html').sort((a, b) => a.name.localeCompare(b.name));
            this.setCache(htmlFiles); return htmlFiles;
        } catch (error) { console.error('Erro ao listar arquivos:', error); throw error; }
    }
    async get(filename) {
        if (!this.tokenManager.isLoaded()) throw new Error('Token n√£o carregado');
        const path = `${this.config.repo.folder}/${filename}`;
        const url = `https://api.github.com/repos/${this.config.repo.owner}/${this.config.repo.name}/contents/${path}`;
        const response = await fetch(url, { headers: this.tokenManager.getAuthHeaders() });
        if (!response.ok) throw new Error(`${response.status}: ${response.statusText}`);
        const data = await response.json();
        return { content: data.content ? this.decodeBase64(data.content) : '', sha: data.sha };
    }
    async save(filename, content) {
        if (!this.tokenManager.isLoaded()) throw new Error('Token n√£o carregado');
        const path = `${this.config.repo.folder}/${filename}`;
        const url = `https://api.github.com/repos/${this.config.repo.owner}/${this.config.repo.name}/contents/${path}`;
        let sha = null; try { const existing = await this.get(filename); sha = existing.sha;} catch {}
        const body = { message: `${sha ? 'Atualiza' : 'Cria'} ${filename}`, content: this.encodeBase64(content), branch: this.config.repo.branch };
        if (sha) body.sha = sha;
        const response = await fetch(url, { method: 'PUT', headers: { 'Content-Type': 'application/json', ...this.tokenManager.getAuthHeaders() }, body: JSON.stringify(body)});
        if (!response.ok) { const data = await response.json(); throw new Error(data.message || `${response.status}: ${response.statusText}`);}
        this.clearCache(); return await response.json();
    }
    async delete(filename) {
        if (!this.tokenManager.isLoaded()) throw new Error('Token n√£o carregado');
        const file = await this.get(filename);
        const path = `${this.config.repo.folder}/${filename}`;
        const url = `https://api.github.com/repos/${this.config.repo.owner}/${this.config.repo.name}/contents/${path}`;
        const response = await fetch(url, { method: 'DELETE', headers: { 'Content-Type': 'application/json', ...this.tokenManager.getAuthHeaders() }, body: JSON.stringify({message: `Remove ${filename}`, sha: file.sha, branch: this.config.repo.branch}) });
        if (!response.ok) { const data = await response.json(); throw new Error(data.message || `${response.status}: ${response.statusText}`);}
        this.clearCache(); return true;
    }
    encodeBase64(str) { return btoa(unescape(encodeURIComponent(str))); }
    decodeBase64(str) { try { return decodeURIComponent(escape(atob(str.replace(/\s/g, ''))));} catch { throw new Error('Erro ao decodificar conte√∫do'); }}
    getCache() {
        try { const cached = localStorage.getItem(this.config.cache.filesKey); if (!cached) return null;
            const { files, timestamp } = JSON.parse(cached);
            if (Date.now() - timestamp > this.config.cache.duration) { this.clearCache(); return null;}
            return files;
        } catch { return null;}
    }
    setCache(files) {
        try { localStorage.setItem(this.config.cache.filesKey, JSON.stringify({files, timestamp: Date.now()})); }
        catch (error) { console.warn('N√£o foi poss√≠vel salvar cache:', error);}
    }
    clearCache() { try { localStorage.removeItem(this.config.cache.filesKey); } catch {} }
}
class UIManager {
    constructor(elements) { this.elements = elements; this.statusTimer = null;}
    setStatus(message, type = 'info', options = {}) {
        clearTimeout(this.statusTimer);
        if (!message) {
            this.elements.status.className = 'status';
            this.elements.status.style.display = 'none';
            this.elements.status.textContent = '';
            return;
        }
        this.elements.status.className = `status status-${type}`;
        this.elements.status.style.display = 'block';
        if (options.asHtml) { this.elements.status.innerHTML = this.sanitizeHtml(message);}
        else { this.elements.status.textContent = message;}
        if (options.autoHide) { this.statusTimer = setTimeout(() => this.setStatus(null), options.autoHide);}
    }
    updateFilenamePreview(filename) {
        const sanitized = this.sanitizeFilename(filename) || '‚Äî';
        this.elements.sanitizedPreview.textContent = `Nome resultante: ${sanitized}`;
    }
    renderFileList(files) {
        if (!files.length) { this.elements.fileList.innerHTML = '<span class="small">Nenhum arquivo HTML encontrado.</span>'; return;}
        const html = files.map(file => `
            <div class="file-item">
                <div class="file-info">
                    <a href="${this.getPreviewUrl(file.name)}" target="_blank" rel="noopener">${this.escapeHtml(file.name)}</a>
                    <span class="file-path">${this.escapeHtml(`${CONFIG.repo.folder}/${file.name}`)}</span>
                </div>
                <div class="file-actions">
                    <button type="button" class="btn-ghost" data-action="load" data-file="${this.escapeAttr(file.name)}">Editar</button>
                    <button type="button" class="btn-del" data-action="delete" data-file="${this.escapeAttr(file.name)}">Apagar</button>
                </div>
            </div>
        `).join('');
        this.elements.fileList.innerHTML = html;
    }
    setPublishing(isPublishing) {
        this.elements.publishBtn.disabled = isPublishing;
        this.elements.publishBtn.textContent = isPublishing ? '‚è≥ Publicando...' : 'üöÄ Publicar no GitHub';
    }
    getPreviewUrl(filename) { return `${CONFIG.preview.baseUrl}/${CONFIG.repo.folder}/${encodeURIComponent(filename)}`; }
    sanitizeFilename(name) {
        if (!name) return '';
        let base = name;
        if (base.normalize) { base = base.normalize('NFD').replace(/[\u0300-\u036f]/g, ''); }
        base = base.toLowerCase().trim().replace(/\.html?$/g, '').replace(/[^a-z0-9._-]+/g, '-').replace(/-+/g, '-').replace(/^-+|-+$/g, '').replace(/\.+/g, '.').replace(/^\.+|\.+$/g, '');
        return base ? `${base}.html` : '';
    }
    escapeHtml(str) { const div = document.createElement('div'); div.textContent = str; return div.innerHTML;}
    escapeAttr(str) { return this.escapeHtml(str).replace(/"/g, '&quot;').replace(/'/g, ''); }
    sanitizeHtml(html) { return html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, ''); }
}
class PublisherApp {
    constructor(config) {
        this.config = config;
        this.tokenManager = new GitHubTokenManager(config);
        this.fileManager = new GitHubFileManager(config, this.tokenManager);
        this.elements = {
            form: document.getElementById('publishForm'),
            filename: document.getElementById('filename'),
            htmlContent: document.getElementById('htmlContent'),
            publishBtn: document.getElementById('publishBtn'),
            loadExampleBtn: document.getElementById('loadExampleBtn'),
            refreshBtn: document.getElementById('refreshBtn'),
            fileList: document.getElementById('fileList'),
            status: document.getElementById('status'),
            sanitizedPreview: document.getElementById('sanitizedPreview')
        };
        this.ui = new UIManager(this.elements);
        this.init();
    }
    async init() {
        this.setupEventListeners();
        this.ui.updateFilenamePreview(this.elements.filename.value);
        await this.loadToken();
    }
    setupEventListeners() {
        this.elements.form.addEventListener('submit', (e) => this.handlePublish(e));
        this.elements.filename.addEventListener('input', () => this.handleFilenameChange());
        this.elements.htmlContent.addEventListener('input', () => this.updatePublishButton());
        this.elements.loadExampleBtn.addEventListener('click', () => this.loadExample());
        this.elements.refreshBtn.addEventListener('click', () => this.refreshFileList());
        this.elements.fileList.addEventListener('click', (e) => this.handleFileAction(e));
    }
    async loadToken() {
        this.ui.setStatus('Carregando token...', 'info');
        try { await this.tokenManager.load(); this.updatePublishButton(); this.ui.setStatus('Token carregado com sucesso!', 'success', { autoHide: 3200 }); await this.refreshFileList();}
        catch (error) { this.ui.setStatus(`Erro ao carregar token: ${error.message}`, 'error'); this.updatePublishButton(); }
    }
    async refreshFileList() {
        if (!this.tokenManager.isLoaded()) { this.elements.fileList.innerHTML = '<span class="small">Token n√£o carregado.</span>'; return;}
        this.elements.fileList.innerHTML = '<span class="small">Carregando arquivos...</span>';
        try { const files = await this.fileManager.list(); this.ui.renderFileList(files);}
        catch (error) { this.elements.fileList.innerHTML = `<span class="small" style="color:#b72136;">Erro: ${this.ui.escapeHtml(error.message)}</span>`;}
    }
    handleFilenameChange() { this.ui.updateFilenamePreview(this.elements.filename.value); this.updatePublishButton();}
    loadExample() {
        this.elements.htmlContent.value = DEFAULT_EXAMPLE;
        this.updatePublishButton();
        this.ui.setStatus('Exemplo carregado no editor!', 'success', { autoHide: 3200 });
    }
    async handleFileAction(event) {
        const button = event.target.closest('button[data-action]'); if (!button) return;
        const action = button.dataset.action; const filename = button.dataset.file; if (!filename) return;
        if (action === 'load') { await this.loadFile(filename);}
        else if (action === 'delete') { await this.deleteFile(filename);}
    }
    async loadFile(filename) {
        this.ui.setStatus(`Carregando "${filename}"...`, 'info');
        try {
            const file = await this.fileManager.get(filename);
            this.elements.filename.value = filename;
            this.elements.htmlContent.value = file.content;
            this.handleFilenameChange();
            this.ui.setStatus(`Arquivo "${filename}" carregado para edi√ß√£o.`, 'success', { autoHide: 3600 });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } catch (error) {
            this.ui.setStatus(`Erro ao carregar "${filename}": ${error.message}`, 'error');
        }
    }
    async deleteFile(filename) {
        if (!confirm(`Tem certeza que deseja apagar "${filename}"?`)) { return;}
        this.ui.setStatus(`Apagando "${filename}"...`, 'info');
        try {
            await this.fileManager.delete(filename);
            this.ui.setStatus(`Arquivo "${filename}" removido com sucesso.`, 'success', { autoHide: 3600 });
            await this.refreshFileList();
        } catch (error) {
            this.ui.setStatus(`Erro ao apagar "${filename}": ${error.message}`, 'error');
        }
    }
    async handlePublish(event) {
        event.preventDefault();
        const rawFilename = this.elements.filename.value.trim();
        const sanitized = this.ui.sanitizeFilename(rawFilename);
        const htmlContent = this.elements.htmlContent.value.trim();
        if (!sanitized) { this.ui.setStatus('Informe um nome de arquivo v√°lido.', 'error'); return; }
        if (!htmlContent) { this.ui.setStatus('Informe o conte√∫do HTML.', 'error'); return;}
        if (sanitized !== rawFilename) {
            this.elements.filename.value = sanitized;
            this.ui.updateFilenamePreview(sanitized);
        }
        this.ui.setPublishing(true);
        this.ui.setStatus(`Publicando "${sanitized}"...`, 'info');
        try {
            await this.fileManager.save(sanitized, htmlContent);
            const previewUrl = this.ui.getPreviewUrl(sanitized);
            this.ui.setStatus(`Publicado! <a href="${previewUrl}" target="_blank" rel="noopener">Abrir p√°gina publicada</a>`, 'success', { asHtml: true });
            await this.refreshFileList();
        } catch (error) {
            this.ui.setStatus(`Erro ao publicar: ${error.message}`, 'error');
        } finally {
            this.ui.setPublishing(false);
        }
    }
    updatePublishButton() {
        const hasContent = this.elements.htmlContent.value.trim().length > 0;
        const hasValidFilename = Boolean(this.ui.sanitizeFilename(this.elements.filename.value.trim()));
        const canPublish = this.tokenManager.isLoaded() && hasContent && hasValidFilename;
        this.elements.publishBtn.disabled = !canPublish;
    }
}
document.addEventListener('DOMContentLoaded', () => { new PublisherApp(CONFIG); });
</script>
</body>
</html>
