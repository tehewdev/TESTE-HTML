<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xiaomi LYWSD03MMC Manager (Stock Reader)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #0f172a; --card-bg: #1e293b; --accent: #3b82f6; --text-main: #f1f5f9; --text-muted: #94a3b8; --success: #10b981; --error: #ef4444; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-main); display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; }
        .container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 20px; }
        h1 { text-align: center; font-size: 1.5rem; font-weight: 600; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05); }
        
        /* Destaque para Temperatura e Umidade */
        .sensor-display { display: flex; justify-content: space-around; margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; }
        .sensor-item { text-align: center; }
        .sensor-val { font-size: 2.5rem; font-weight: 700; display: block; color: var(--accent); }
        .sensor-label { font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; }
        
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .info-box { background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; }
        .info-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; }
        .info-value { font-size: 1.1rem; font-weight: 600; }
        
        .btn-action { width: 100%; background: var(--accent); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-action:hover { background: #2563eb; }
        .terminal-window { background: #000; border-radius: 12px; height: 200px; overflow: hidden; border: 1px solid #333; display: flex; flex-direction: column; }
        .terminal-content { padding: 15px; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: #0f0; overflow-y: auto; flex-grow: 1; }
        .log-time { color: #666; margin-right: 8px; } .log-err { color: #ef4444; } .log-warn { color: #fbbf24; }
    </style>
</head>
<body>

    <div class="container">
        <h1>LYWSD03MMC <span style="color:var(--accent)">Reader</span></h1>

        <div class="card">
            <div id="connStatus" style="text-align:center; margin-bottom:15px; color:var(--text-muted)">Desconectado</div>
            <button id="btnConnect" class="btn-action">Conectar e Ler</button>
            
            <div class="sensor-display">
                <div class="sensor-item">
                    <span class="sensor-val" id="valTemp">--</span>
                    <span class="sensor-label">Temperatura °C</span>
                </div>
                <div class="sensor-item">
                    <span class="sensor-val" id="valHum">--</span>
                    <span class="sensor-label">Umidade %</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="status-grid">
                <div class="info-box"><div class="info-label">Firmware</div><div class="info-value" id="fwVer">--</div></div>
                <div class="info-box"><div class="info-label">Bateria</div><div class="info-value" id="batLevel">--</div></div>
            </div>
        </div>

        <div class="terminal-window">
            <div class="terminal-content" id="console">
                <div><span class="log-time">--:--</span> Sistema pronto.</div>
            </div>
        </div>
    </div>

    <script>
        const btnConnect = document.getElementById('btnConnect');
        const consoleDiv = document.getElementById('console');
        const ui = {
            temp: document.getElementById('valTemp'),
            hum: document.getElementById('valHum'),
            fw: document.getElementById('fwVer'),
            bat: document.getElementById('batLevel'),
            status: document.getElementById('connStatus')
        };

        let device, server;

        function log(msg, type = 'info') {
            const line = document.createElement('div');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            line.innerHTML = `<span class="log-time">${time}</span> <span class="${type === 'error' ? 'log-err' : type === 'warn' ? 'log-warn' : ''}">${msg}</span>`;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        async function connect() {
            try {
                if (device && device.gatt.connected) {
                    await device.gatt.disconnect();
                    return;
                }

                log("Buscando dispositivos...");
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'LYWSD03' }, { namePrefix: 'ATC' }, { namePrefix: 'Mi' }],
                    optionalServices: [
                        '0000180a-0000-1000-8000-00805f9b34fb', // Device Info
                        '0000180f-0000-1000-8000-00805f9b34fb', // Battery
                        '0000181a-0000-1000-8000-00805f9b34fb', // ATC Temp
                        'ebe0ccb0-7a0a-4b0c-8a1a-6ff2997da3a6'  // Xiaomi Original
                    ]
                });

                device.addEventListener('gattserverdisconnected', () => {
                    ui.status.textContent = "Desconectado";
                    ui.status.style.color = "#94a3b8";
                    btnConnect.textContent = "Conectar e Ler";
                    btnConnect.style.background = "";
                    log("Desconectado.", 'warn');
                });

                log("Conectando...");
                server = await device.gatt.connect();
                
                ui.status.textContent = "Conectado";
                ui.status.style.color = "#10b981";
                btnConnect.textContent = "Desconectar";
                btnConnect.style.background = "#ef4444";

                // 1. Tenta ler Firmware e Bateria (Básico)
                await readBasicInfo(server);

                // 2. Decide qual método usar (ATC Fácil ou Xiaomi Difícil)
                const services = await server.getPrimaryServices();
                const hasATC = services.some(s => s.uuid.includes('181a'));
                
                if (hasATC) {
                    log("Modo ATC detectado (Fácil).");
                    await startATCReading(server);
                } else {
                    log("Modo Xiaomi Original detectado.");
                    log("⚠️ ATENÇÃO: Para ler dados do firmware original, é necessário ativar notificações no UUID ebe0...", 'warn');
                    
                    // Tenta ler o UUID proprietário da Xiaomi
                    try {
                        const service = await server.getPrimaryService('ebe0ccb0-7a0a-4b0c-8a1a-6ff2997da3a6');
                        // Característica de dados (Notification)
                        const char = await service.getCharacteristic('ebe0ccc1-7a0a-4b0c-8a1a-6ff2997da3a6');
                        
                        await char.startNotifications();
                        char.addEventListener('characteristicvaluechanged', handleXiaomiData);
                        log("Escutando dados Xiaomi... Aguarde atualização.");
                    } catch(e) {
                        log("Erro ao acessar serviço Xiaomi: " + e.message, 'error');
                        log("DICA: Troque o firmware para ATC para facilitar.", 'warn');
                    }
                }

            } catch (err) {
                log("Erro: " + err.message, 'error');
            }
        }

        async function readBasicInfo(server) {
            try {
                const infoService = await server.getPrimaryService('0000180a-0000-1000-8000-00805f9b34fb');
                const fwChar = await infoService.getCharacteristic('00002a26-0000-1000-8000-00805f9b34fb');
                const fwVal = await fwChar.readValue();
                ui.fw.textContent = new TextDecoder().decode(fwVal);

                const batService = await server.getPrimaryService('0000180f-0000-1000-8000-00805f9b34fb');
                const batChar = await batService.getCharacteristic('00002a19-0000-1000-8000-00805f9b34fb');
                const batVal = await batChar.readValue();
                ui.bat.textContent = batVal.getUint8(0) + "%";
            } catch (e) { console.log(e); }
        }

        async function startATCReading(server) {
            try {
                const service = await server.getPrimaryService('0000181a-0000-1000-8000-00805f9b34fb');
                const char = await service.getCharacteristic('00002a6e-0000-1000-8000-00805f9b34fb'); // Temp
                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', (e) => {
                    const val = e.target.value;
                    const temp = val.getInt16(0, true) / 100;
                    ui.temp.textContent = temp.toFixed(1);
                    log(`Temp: ${temp}°C`);
                });
                
                // Umidade ATC (simples, lê uma vez para testar)
                const humChar = await service.getCharacteristic('00002a6f-0000-1000-8000-00805f9b34fb');
                const humVal = await humChar.readValue();
                ui.hum.textContent = (humVal.getUint16(0, true) / 100).toFixed(0);

            } catch(e) { log("Erro ATC: " + e.message, 'error'); }
        }

        function handleXiaomiData(event) {
            const value = event.target.value;
            // O Firmware original manda dados brutos aqui (0xebe0ccc1)
            // O formato é complexo e geralmente requer descriptografia se estiver pareado.
            // Mas às vezes os bytes 0-2 contêm temperatura * 100 se não estiver criptografado.
            
            // Tentativa de interpretação direta (Sem BindKey):
            if (value.byteLength >= 5) {
                const temp = value.getInt16(0, true) / 100;
                const hum = value.getUint8(2);
                
                log(`Dados Recebidos Raw: ${temp}°C / ${hum}%`);
                
                // Filtro básico para evitar lixo
                if(temp > -40 && temp < 80) ui.temp.textContent = temp.toFixed(1);
                if(hum > 0 && hum <= 100) ui.hum.textContent = hum;
            } else {
                log("Pacote Xiaomi recebido (Criptografado ou Incompatível)", 'warn');
            }
        }

        btnConnect.addEventListener('click', connect);
    </script>
</body>
</html>